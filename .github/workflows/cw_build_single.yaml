name: Build (Single job)

on:
  workflow_call:
    inputs:
      host:
        description: The host machine to be used for the build process.
        required: true
        type: string
      configs:
        description: A json array of configuration names that should be build.
        required: true
        type: string
      platform:
        description: The platform we want to build for.
        required: true
        type: string
      architecture:
        description: The architecture we want to build for.
        required: true
        type: string

jobs:
  build_configurations_windows:
    name: ${{ inputs.platform }}
    continue-on-error: true
    runs-on: ${{ inputs.host }}
    strategy:
      matrix:
        config: ${{ fromJSON(inputs.configs) }}
    steps:
    - uses: actions/checkout@v2

    - name: Prepare workspace
      shell: pwsh
      run: |
        pip3 install setuptools
        pip3 install wheel
        pip3 install conan
        conan config install https://github.com/iceshard-engine/conan-config.git

    - name: Cache Conan packages
      uses: actions/cache@v2
      env:
        cache-name: cache-conan-packages
      with:
        path: ~/.conan
        key: ${{ runner.os }}-build-${{ env.cache-name }}

    - name: Build targets
      shell: pwsh
      run: |
        $BuildTargets = "${{ join(fromJSON(needs.setup_workflow.outputs.build_configs), '","') }}" | ForEach-Object { "-t all-${{matrix.arch}}-$_" }
        $BuildTargetsStr = $BuildTargets -join " "

        .\tools\gh_ice.ps1 init
        .\tools\gh_ice.ps1 build $BuildTargetsStr

    - name: Run tests
      shell: pwsh
      run: |
        $BuildTargets = "${{ join(fromJSON(needs.setup_workflow.outputs.build_configs), '","') }}" | ForEach-Object { "-t test-all-${{matrix.arch}}-$_" }
        $BuildTargetsStr = $BuildTargets -join " "

        .\tools\gh_ice.ps1 build $BuildTargetsStr
